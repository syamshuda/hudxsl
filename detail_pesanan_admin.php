<?php
// /admin/detail_pesanan_admin.php (Versi Perbaikan Final)
$page_title = "Detail Pesanan";
require_once '../includes/header_admin.php';

if (!isset($_GET['id'])) {
    header("Location: kelola_pesanan.php");
        exit();
        }
        $pesanan_id = (int)$_GET['id'];

        // Ambil data pesanan utama
        $stmt_pesanan = $koneksi->prepare("
            SELECT p.*, u.nama_lengkap as nama_pembeli, u.email as email_pembeli
                FROM pesanan p
                    JOIN users u ON p.pembeli_id = u.id
                        WHERE p.id = ?");
                        $stmt_pesanan->bind_param("i", $pesanan_id);
                        $stmt_pesanan->execute();
                        $pesanan = $stmt_pesanan->get_result()->fetch_assoc();
                        $stmt_pesanan->close();

                        if (!$pesanan) {
                            echo "<div class='alert alert-danger'>Pesanan tidak ditemukan.</div>";
                                require_once '../includes/footer_admin.php';
                                    exit();
                                    }

                                    // Ambil data pembayaran jika ada
                                    $stmt_pembayaran = $koneksi->prepare("SELECT * FROM pembayaran WHERE pesanan_id = ? ORDER BY tanggal_bayar DESC LIMIT 1");
                                    $stmt_pembayaran->bind_param("i", $pesanan_id);
                                    $stmt_pembayaran->execute();
                                    $pembayaran = $stmt_pembayaran->get_result()->fetch_assoc();
                                    $stmt_pembayaran->close();

                                    // Ambil detail item yang dipesan
                                    $result_detail = mysqli_query($koneksi, "SELECT pr.nama_produk, dp.jumlah, dp.harga_satuan FROM detail_pesanan dp JOIN produk pr ON dp.produk_id = pr.id WHERE dp.pesanan_id = $pesanan_id");

                                    ?>

                                    <h3>Detail Pesanan #<?php echo $pesanan_id; ?></h3>
                                    <p>
                                        Pembeli: <strong><?php echo htmlspecialchars($pesanan['nama_pembeli']); ?></strong> (<?php echo htmlspecialchars($pesanan['email_pembeli']); ?>)
                                        </p>

                                        <?php
                                        if(isset($_GET['status']) && $_GET['status'] == 'sukses') {
                                            echo '<div class="alert alert-success">Status pembayaran berhasil diperbarui.</div>';
                                            }
                                            ?>

                                            <div class="row">
                                                <div class="col-md-7">
                                                        <div class="card">
                                                                    <div class="card-header">Rincian Barang</div>
                                                                                <div class="card-body">
                                                                                                <table class="table">
                                                                                                                    <thead>
                                                                                                                                            <tr>
                                                                                                                                                                        <th>Produk</th>
                                                                                                                                                                                                    <th class="text-center">Jumlah</th>
                                                                                                                                                                                                                                <th class="text-end">Subtotal</th>
                                                                                                                                                                                                                                                        </tr>
                                                                                                                                                                                                                                                                            </thead>
                                                                                                                                                                                                                                                                                                <tbody>
                                                                                                                                                                                                                                                                                                                        <?php while($item = mysqli_fetch_assoc($result_detail)): ?>
                                                                                                                                                                                                                                                                                                                                                <tr>
                                                                                                                                                                                                                                                                                                                                                                            <td><?php echo htmlspecialchars($item['nama_produk']); ?></td>
                                                                                                                                                                                                                                                                                                                                                                                                        <td class="text-center"><?php echo $item['jumlah']; ?></td>
                                                                                                                                                                                                                                                                                                                                                                                                                                    <td class="text-end">Rp <?php echo number_format($item['jumlah'] * $item['harga_satuan']); ?></td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                            </tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php endwhile; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </tbody>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <tfoot>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <tr class="fw-bold">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <td colspan="2" class="text-end">Total Harga</td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <td class="text-end">Rp <?php echo number_format($pesanan['total_harga']); ?></td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <tr class="fw-bold">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <td colspan="2" class="text-end">Total Unik Dibayar</td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <td class="text-end text-primary">Rp <?php echo number_format($pesanan['total_dengan_kode'] ?? $pesanan['total_harga']); ?></td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </tfoot>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </table>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <p class="mt-3">Status Pesanan Saat Ini: <strong><?php echo str_replace('_', ' ', ucfirst($pesanan['status_pesanan'])); ?></strong></p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <div class="col-md-5">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <div class="card">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <div class="card-header">Verifikasi Pembayaran</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <div class="card-body text-center">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <?php
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             // ---- BAGIAN PERUBAHAN UTAMA: Kondisi untuk menampilkan bukti dan opsi konfirmasi ----
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             // Tampilkan bukti pembayaran jika ada, dan status pembayaran 'menunggu' di tabel 'pembayaran'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             if ($pembayaran && $pembayaran['status_konfirmasi'] == 'menunggu' && $pesanan['status_pesanan'] == 'pending'): ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <p>Bukti diunggah pada: <?php echo date('d M Y, H:i', strtotime($pembayaran['tanggal_bayar'])); ?></p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <a href="/uploads/bukti_pembayaran/<?php echo $pembayaran['bukti_pembayaran']; ?>" target="_blank">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <img src="/uploads/bukti_pembayaran/<?php echo $pembayaran['bukti_pembayaran']; ?>" class="img-fluid img-thumbnail mb-3" alt="Bukti Pembayaran">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </a>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <hr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <p>Status Konfirmasi: <strong><?php echo ucfirst($pembayaran['status_konfirmasi']); ?></strong></p>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <form action="proses_konfirmasi_pembayaran.php" method="POST" class="d-grid gap-2">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <input type="hidden" name="pembayaran_id" value="<?php echo $pembayaran['id']; ?>">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <input type="hidden" name="pesanan_id" value="<?php echo $pesanan_id; ?>">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <button type="submit" name="action" value="konfirmasi" class="btn btn-success">Konfirmasi Pembayaran</button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <button type="submit" name="action" value="tolak" class="btn btn-danger">Tolak Pembayaran</button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </form>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <?php
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 // Tampilkan status pembayaran yang sudah dikonfirmasi/ditolak oleh admin
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 elseif ($pembayaran && ($pembayaran['status_konfirmasi'] == 'dikonfirmasi' || $pembayaran['status_konfirmasi'] == 'ditolak')): ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <p>Bukti diunggah pada: <?php echo date('d M Y, H:i', strtotime($pembayaran['tanggal_bayar'])); ?></p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <a href="/uploads/bukti_pembayaran/<?php echo $pembayaran['bukti_pembayaran']; ?>" target="_blank">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <img src="/uploads/bukti_pembayaran/<?php echo $pembayaran['bukti_pembayaran']; ?>" class="img-fluid img-thumbnail mb-3" alt="Bukti Pembayaran">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </a>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <hr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <p>Status Konfirmasi:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <strong>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <?php
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             $konf_status = $pembayaran['status_konfirmasi'];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         $konf_badge = ($konf_status == 'dikonfirmasi') ? 'bg-success' : 'bg-danger';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     echo '<span class="badge ' . $konf_badge . '">' . ucfirst($konf_status) . '</span>';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </strong>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <br>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <small class="text-muted">pada <?php echo date('d M Y, H:i', strtotime($pembayaran['tanggal_proses'] ?? $pembayaran['tanggal_bayar'])); ?></small>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <?php
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             // Jika belum ada bukti pembayaran diunggah (status pesanan masih 'menunggu_pembayaran')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             elseif ($pesanan['status_pesanan'] == 'menunggu_pembayaran'): ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <p class="text-muted">Pembeli belum mengunggah bukti pembayaran.</p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <?php
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 // Jika pesanan sudah diproses, dikirim, atau selesai (tidak relevan lagi dengan konfirmasi pembayaran)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 else: ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <p class="text-muted">Pembayaran sudah terverifikasi.</p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <?php endif; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <?php require_once '../includes/footer_admin.php'; ?>