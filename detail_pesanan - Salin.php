<?php
// /penjual/detail_pesanan.php (Versi Final dengan Info COD & Catatan)
$page_title = "Detail Pesanan";
require_once '../includes/header_penjual.php';

if (!isset($_GET['id'])) { header("Location: pesanan_masuk.php"); exit(); }
$pesanan_id = (int)$_GET['id'];
$user_id = $_SESSION['user_id'];

// Ambil detail pesanan utama, termasuk metode pembayaran dan catatan
$query = "
    SELECT p.* FROM pesanan p
        JOIN detail_pesanan dp ON p.id = dp.pesanan_id
            JOIN produk pr ON dp.produk_id = pr.id
                JOIN toko t ON pr.toko_id = t.id
                    WHERE p.id = ? AND t.user_id = ?
                        GROUP BY p.id
                            LIMIT 1
                            ";
                            $stmt = $koneksi->prepare($query);
                            $stmt->bind_param("ii", $pesanan_id, $user_id);
                            $stmt->execute();
                            $pesanan = $stmt->get_result()->fetch_assoc();
                            $stmt->close();

                            if (!$pesanan) { 
                                echo "<div class='alert alert-danger'>Pesanan tidak ditemukan atau Anda tidak memiliki akses.</div>";
                                    require_once '../includes/footer_penjual.php';
                                        exit();
                                        }

                                        // Ambil rincian produknya
                                        $query_items = "
                                            SELECT pr.nama_produk, pr.jenis_produk, pr.link_digital, dp.jumlah, dp.harga_satuan 
                                                FROM detail_pesanan dp 
                                                    JOIN produk pr ON dp.produk_id = pr.id 
                                                        JOIN toko t ON pr.toko_id = t.id 
                                                            WHERE dp.pesanan_id = ? AND t.user_id = ?
                                                            ";
                                                            $stmt_items = $koneksi->prepare($query_items);
                                                            $stmt_items->bind_param("ii", $pesanan_id, $user_id);
                                                            $stmt_items->execute();
                                                            $items_result = $stmt_items->get_result();

                                                            $ada_produk_fisik = false;
                                                            $items_array = [];
                                                            while ($item = $items_result->fetch_assoc()) {
                                                                $items_array[] = $item;
                                                                    if ($item['jenis_produk'] == 'fisik') $ada_produk_fisik = true;
                                                                    }
                                                                    $stmt_items->close();

                                                                    ?>

                                                                    <h3>Detail Pesanan #<?php echo $pesanan['id']; ?></h3>
                                                                    <hr>

                                                                    <div class="row">
                                                                        <div class="col-lg-7">
                                                                                <div class="card mb-4">
                                                                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                                                                            <span>Rincian Barang Anda</span>
                                                                                                                            <span class="badge bg-dark"><?php echo htmlspecialchars($pesanan['metode_pembayaran']); ?></span>
                                                                                                                                        </div>
                                                                                                                                                    <div class="card-body">
                                                                                                                                                                    <table class="table">
                                                                                                                                                                                        <thead>
                                                                                                                                                                                                                <tr><th>Produk</th><th class="text-center">Jumlah</th><th class="text-end">Subtotal</th></tr>
                                                                                                                                                                                                                                    </thead>
                                                                                                                                                                                                                                                        <tbody>
                                                                                                                                                                                                                                                                                <?php foreach($items_array as $item): ?>
                                                                                                                                                                                                                                                                                                        <tr>
                                                                                                                                                                                                                                                                                                                                    <td>
                                                                                                                                                                                                                                                                                                                                                                    <?php echo htmlspecialchars($item['nama_produk']); ?>
                                                                                                                                                                                                                                                                                                                                                                                                    <?php if($item['jenis_produk'] == 'digital'): ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                        <span class="badge bg-info text-dark">Digital</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <?php endif; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <td class="text-center">x <?php echo $item['jumlah']; ?></td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <td class="text-end">Rp <?php echo number_format($item['harga_satuan'] * $item['jumlah']); ?></td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <?php endforeach; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </tbody>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </table>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <?php if (!empty($pesanan['catatan_pembeli'])): ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div class="card mb-4">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <div class="card-header">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <h5><i class="bi bi-chat-left-text"></i> Catatan dari Pembeli</h5>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div class="card-body">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <p class="fst-italic">"<?php echo nl2br(htmlspecialchars($pesanan['catatan_pembeli'])); ?>"</p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php endif; ?>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <div class="col-lg-5">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php if($ada_produk_fisik): ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <div class="card mb-4">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div class="card-header">Alamat Pengiriman</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div class="card-body">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <strong><?php echo htmlspecialchars($pesanan['nama_penerima']); ?></strong><br>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php echo htmlspecialchars($pesanan['no_telepon']); ?><br>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php echo nl2br(htmlspecialchars($pesanan['alamat_lengkap'])); ?><br>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php echo htmlspecialchars($pesanan['kecamatan']); ?>, <?php echo htmlspecialchars($pesanan['kota']); ?><br>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php echo htmlspecialchars($pesanan['provinsi']); ?>, <?php echo htmlspecialchars($pesanan['kode_pos']); ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php endif; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <div class="card">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <div class="card-header">Aksi</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div class="card-body">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <p>Status Saat Ini: <span class="badge bg-primary fs-6"><?php echo ucfirst(str_replace('_', ' ', $pesanan['status_pesanan'])); ?></span></p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <hr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <?php if($pesanan['status_pesanan'] == 'diproses'): ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <form action="proses_update_pesanan.php" method="POST">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <input type="hidden" name="pesanan_id" value="<?php echo $pesanan['id']; ?>">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <div class="mb-3">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <label for="nomor_resi" class="form-label">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php echo $ada_produk_fisik ? 'Masukkan Nomor Resi' : 'Keterangan Pengiriman'; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </label>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <input type="text" name="nomor_resi" id="nomor_resi" class="form-control" 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   value="<?php echo $ada_produk_fisik ? '' : 'Produk digital telah dikirim via email'; ?>" 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <?php if ($ada_produk_fisik && $pesanan['metode_pembayaran'] !== 'COD') echo 'required'; ?>>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <?php if ($pesanan['metode_pembayaran'] === 'COD'): ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <small class="form-text text-muted">Untuk pesanan COD, nomor resi opsional. Anda bisa mengisinya dengan keterangan seperti "Dikirim oleh kurir toko".</small>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <?php endif; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <div class="d-grid">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <button type="submit" name="action" value="kirim" class="btn btn-success">Tandai Sebagai Dikirim</button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </form>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <?php elseif($pesanan['status_pesanan'] == 'dikirim'): ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <p class="text-success"><i class="bi bi-check-circle-fill"></i> Pesanan telah dikirim pada <?php echo date('d M Y H:i', strtotime($pesanan['tanggal_dikirim'])); ?>.</p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   <?php if($ada_produk_fisik && !empty($pesanan['nomor_resi'])): ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       <p>No. Resi/Keterangan: <strong><?php echo htmlspecialchars($pesanan['nomor_resi']); ?></strong></p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <?php endif; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <?php else: ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <p class="text-muted">Tidak ada aksi yang diperlukan untuk status pesanan ini.</p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <?php endif; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                $koneksi->close();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                require_once '../includes/footer_penjual.php'; 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ?>