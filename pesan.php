<?php
// /penjual/pesan.php (Versi Final dengan Alur Master-Detail)

$page_title = "Pesan Masuk";
require_once '../includes/header_penjual.php';

$user_id = $_SESSION['user_id'];

// Logika untuk mengirim pesan baru
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['kirim_pesan'])) {
    $penerima_id = (int)$_POST['penerima_id'];
        $isi_pesan = trim($_POST['isi_pesan']);
            if (!empty($isi_pesan) && $penerima_id > 0) {
                    $stmt_kirim = $koneksi->prepare("INSERT INTO pesan (pengirim_id, penerima_id, isi_pesan) VALUES (?, ?, ?)");
                            $stmt_kirim->bind_param("iis", $user_id, $penerima_id, $isi_pesan);
                                    if ($stmt_kirim->execute()) {
                                                header("Location: " . BASE_URL . "/penjual/pesan.php?chat_with=" . $penerima_id);
                                                            exit();
                                                                    }
                                                                        }
                                                                        }

                                                                        $chat_dengan_id = isset($_GET['chat_with']) ? (int)$_GET['chat_with'] : null;

                                                                        if ($chat_dengan_id) {
                                                                            // TAMPILAN DETAIL CHAT (PRIVATE)

                                                                                // Ambil nama lawan chat
                                                                                    $stmt_lawan = $koneksi->prepare("SELECT u.nama_lengkap, t.nama_toko FROM users u LEFT JOIN toko t ON u.id = t.user_id WHERE u.id = ?");
                                                                                        $stmt_lawan->bind_param("i", $chat_dengan_id);
                                                                                            $stmt_lawan->execute();
                                                                                                $lawan_chat = $stmt_lawan->get_result()->fetch_assoc();
                                                                                                    $nama_lawan_chat = !empty($lawan_chat['nama_toko']) ? $lawan_chat['nama_toko'] : $lawan_chat['nama_lengkap'];
                                                                                                        $stmt_lawan->close();
                                                                                                            
                                                                                                                // Tandai pesan sebagai sudah dibaca
                                                                                                                    $stmt_baca = $koneksi->prepare("UPDATE pesan SET sudah_dibaca = 1 WHERE pengirim_id = ? AND penerima_id = ? AND sudah_dibaca = 0");
                                                                                                                        $stmt_baca->bind_param("ii", $chat_dengan_id, $user_id);
                                                                                                                            $stmt_baca->execute();

                                                                                                                                ?>
                                                                                                                                    <div class="d-flex align-items-center mb-3">
                                                                                                                                            <a href="pesan.php" class="btn btn-light me-3"><i class="bi bi-arrow-left"></i></a>
                                                                                                                                                    <h4>Chat dengan <?php echo htmlspecialchars($nama_lawan_chat); ?></h4>
                                                                                                                                                        </div>
                                                                                                                                                            <div class="chat-container border rounded">
                                                                                                                                                                    <div class="chat-box">
                                                                                                                                                                                <div class="chat-content">
                                                                                                                                                                                                <?php
                                                                                                                                                                                                                $query_pesan = "SELECT * FROM pesan WHERE (pengirim_id = ? AND penerima_id = ?) OR (pengirim_id = ? AND penerima_id = ?) ORDER BY created_at DESC LIMIT 50";
                                                                                                                                                                                                                                $stmt_pesan = $koneksi->prepare($query_pesan);
                                                                                                                                                                                                                                                $stmt_pesan->bind_param("iiii", $user_id, $chat_dengan_id, $chat_dengan_id, $user_id);
                                                                                                                                                                                                                                                                $stmt_pesan->execute();
                                                                                                                                                                                                                                                                                $hasil_pesan = $stmt_pesan->get_result();
                                                                                                                                                                                                                                                                                                $pesan_array = mysqli_fetch_all($hasil_pesan, MYSQLI_ASSOC);
                                                                                                                                                                                                                                                                                                                foreach (array_reverse($pesan_array) as $pesan):
                                                                                                                                                                                                                                                                                                                                    $bubble_class = ($pesan['pengirim_id'] == $user_id) ? 'bubble-sent' : 'bubble-received';
                                                                                                                                                                                                                                                                                                                                                    ?>
                                                                                                                                                                                                                                                                                                                                                                        <div class="chat-bubble <?php echo $bubble_class; ?>">
                                                                                                                                                                                                                                                                                                                                                                                                <div><?php echo nl2br(htmlspecialchars($pesan['isi_pesan'])); ?></div>
                                                                                                                                                                                                                                                                                                                                                                                                                        <div class="small text-muted text-end mt-1" style="font-size: 0.7rem;"><?php echo date('H:i', strtotime($pesan['created_at'])); ?></div>
                                                                                                                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                            <?php endforeach; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div class="chat-input p-2 border-top">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <form method="POST" action="pesan.php?chat_with=<?php echo $chat_dengan_id; ?>">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <input type="hidden" name="penerima_id" value="<?php echo $chat_dengan_id; ?>">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <input type="hidden" name="kirim_pesan" value="1">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div class="input-group">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <textarea name="isi_pesan" class="form-control" placeholder="Ketik balasan..." required rows="1"></textarea>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <button class="btn btn-primary" type="submit">Kirim</button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </form>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <?php
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // TAMPILAN DAFTAR PERCAKAPAN
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                $query_percakapan = "
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        SELECT u.id, u.nama_lengkap, t.nama_toko, t.logo_toko,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                (SELECT isi_pesan FROM pesan WHERE (pengirim_id = u.id AND penerima_id = ?) OR (penerima_id = u.id AND pengirim_id = ?) ORDER BY created_at DESC LIMIT 1) as pesan_terakhir,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        (SELECT created_at FROM pesan WHERE (pengirim_id = u.id AND penerima_id = ?) OR (penerima_id = u.id AND pengirim_id = ?) ORDER BY created_at DESC LIMIT 1) as waktu_terakhir,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                (SELECT COUNT(id) FROM pesan WHERE pengirim_id = u.id AND penerima_id = ? AND sudah_dibaca = 0) as belum_dibaca
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        FROM users u
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                LEFT JOIN toko t ON u.id = t.user_id
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        JOIN (SELECT pengirim_id as user_lain_id FROM pesan WHERE penerima_id = ? UNION SELECT penerima_id as user_lain_id FROM pesan WHERE pengirim_id = ?) AS percakapan ON u.id = percakapan.user_lain_id
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                GROUP BY u.id ORDER BY waktu_terakhir DESC";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        $stmt_percakapan = $koneksi->prepare($query_percakapan);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            $stmt_percakapan->bind_param("iiiiiii", $user_id, $user_id, $user_id, $user_id, $user_id, $user_id, $user_id);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                $stmt_percakapan->execute();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    $hasil_percakapan = $stmt_percakapan->get_result();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <h4>Percakapan</h4>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <div class="list-group-flush border rounded mt-3">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <?php if ($hasil_percakapan && $hasil_percakapan->num_rows > 0): ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php while ($percakapan = $hasil_percakapan->fetch_assoc()):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    $display_name = !empty($percakapan['nama_toko']) ? $percakapan['nama_toko'] : $percakapan['nama_lengkap'];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    $avatar_path = !empty($percakapan['logo_toko']) ? '/uploads/logo_toko/' . htmlspecialchars($percakapan['logo_toko']) : 'https://ui-avatars.com/api/?name=' . urlencode($display_name) . '&background=random';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <a href="?chat_with=<?php echo $percakapan['id']; ?>" class="chat-list-item">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div class="chat-list-avatar">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <img src="<?php echo $avatar_path; ?>" class="rounded-circle" alt="Avatar">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div class="chat-list-info ms-3">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <h6 class="mb-1"><?php echo htmlspecialchars($display_name); ?></h6>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <p><?php echo htmlspecialchars($percakapan['pesan_terakhir'] ?? '...'); ?></p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <div class="chat-list-meta">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php if ($percakapan['waktu_terakhir']): ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <div><?php echo date('d/m', strtotime($percakapan['waktu_terakhir'])); ?></div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <?php endif; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php if ($percakapan['belum_dibaca'] > 0): ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <div class="unread-badge"><?php echo $percakapan['belum_dibaca']; ?></div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php endif; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </a>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php endwhile; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <?php else: ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div class="list-group-item text-center p-4 text-muted">Belum ada percakapan.</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php endif; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <?php
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        require_once '../includes/footer_penjual.php';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ?>