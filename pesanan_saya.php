<?php
// /pesanan_saya.php
require_once 'config/database.php';

if (!isset($_SESSION['user_id'])) {
    header("Location: /auth/login.php");
        exit();
        }
        $pembeli_id = $_SESSION['user_id'];

        $where_clause = "";
        $page_subtitle = "Semua Pesanan";

        // ---- BAGIAN PERUBAHAN UTAMA: Tambahkan 'pending' ke valid_statuses ----
        $valid_statuses = ['menunggu_pembayaran', 'pending', 'diproses', 'dikirim', 'selesai', 'dibatalkan'];
        $status_filter = ''; // Inisialisasi

        if (isset($_GET['status']) && !empty($_GET['status'])) {
            // Pastikan filter status valid sebelum digunakan
                if (in_array($_GET['status'], $valid_statuses)) {
                        $status_filter = mysqli_real_escape_string($koneksi, $_GET['status']);
                                $where_clause = "AND status_pesanan = '$status_filter'";
                                        $page_subtitle = "Pesanan " . ucfirst(str_replace('_', ' ', $status_filter));
                                            } else {
                                                    // Jika status tidak valid, abaikan filter atau redirect ke 'semua'
                                                            $page_subtitle = "Semua Pesanan"; // Kembali ke default jika filter tidak valid
                                                                }
                                                                }
                                                                // ---- AKHIR BAGIAN PERUBAHAN UTAMA ----

                                                                $page_title = "Riwayat Pesanan Saya";
                                                                require_once 'includes/header.php';

                                                                $query = "SELECT * FROM pesanan WHERE pembeli_id = ? $where_clause ORDER BY tanggal_pesanan DESC";
                                                                $stmt = $koneksi->prepare($query);
                                                                $stmt->bind_param("i", $pembeli_id);
                                                                $stmt->execute();
                                                                $result = $stmt->get_result();
                                                                ?>

                                                                <h1>Riwayat Pesanan Saya</h1>
                                                                <h5 class="text-muted mb-4"><?php echo $page_subtitle; ?></h5>

                                                                <ul class="nav nav-tabs mb-3">
                                                                    <li class="nav-item">
                                                                            <a class="nav-link <?php if($status_filter == '') echo 'active'; ?>" href="?status=semua">Semua</a>
                                                                                </li>
                                                                                    <li class="nav-item">
                                                                                            <a class="nav-link <?php if($status_filter == 'menunggu_pembayaran') echo 'active'; ?>" href="?status=menunggu_pembayaran">Menunggu Pembayaran</a>
                                                                                                </li>
                                                                                                    <li class="nav-item">
                                                                                                            <a class="nav-link <?php if($status_filter == 'pending') echo 'active'; ?>" href="?status=pending">Menunggu Konfirmasi</a>
                                                                                                                </li>
                                                                                                                     <li class="nav-item">
                                                                                                                             <a class="nav-link <?php if($status_filter == 'diproses') echo 'active'; ?>" href="?status=diproses">Diproses</a>
                                                                                                                                 </li>
                                                                                                                                     <li class="nav-item">
                                                                                                                                             <a class="nav-link <?php if($status_filter == 'dikirim') echo 'active'; ?>" href="?status=dikirim">Dikirim</a>
                                                                                                                                                 </li>
                                                                                                                                                     <li class="nav-item">
                                                                                                                                                             <a class="nav-link <?php if($status_filter == 'selesai') echo 'active'; ?>" href="?status=selesai">Selesai</a>
                                                                                                                                                                 </li>
                                                                                                                                                                     <li class="nav-item">
                                                                                                                                                                             <a class="nav-link <?php if($status_filter == 'dibatalkan') echo 'active'; ?>" href="?status=dibatalkan">Dibatalkan</a>
                                                                                                                                                                                 </li>
                                                                                                                                                                                 </ul>


                                                                                                                                                                                 <div class="card shadow-sm">
                                                                                                                                                                                     <div class="card-body">
                                                                                                                                                                                             <div class="table-responsive">
                                                                                                                                                                                                         <table class="table table-hover align-middle">
                                                                                                                                                                                                                         <thead class="table-light">
                                                                                                                                                                                                                                             <tr>
                                                                                                                                                                                                                                                                     <th>No. Pesanan</th>
                                                                                                                                                                                                                                                                                             <th>Tanggal</th>
                                                                                                                                                                                                                                                                                                                     <th>Total Harga</th>
                                                                                                                                                                                                                                                                                                                                             <th>Status</th>
                                                                                                                                                                                                                                                                                                                                                                     <th>Aksi</th>
                                                                                                                                                                                                                                                                                                                                                                                         </tr>
                                                                                                                                                                                                                                                                                                                                                                                                         </thead>
                                                                                                                                                                                                                                                                                                                                                                                                                         <tbody>
                                                                                                                                                                                                                                                                                                                                                                                                                                             <?php if ($result->num_rows > 0): ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <?php while ($pesanan = $result->fetch_assoc()): ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <td>#<?php echo $pesanan['id']; ?></td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <td><?php echo date('d M Y', strtotime($pesanan['tanggal_pesanan'])); ?></td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <td>Rp <?php echo number_format($pesanan['total_dengan_kode'] ?? $pesanan['total_harga']); ?></td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <?php
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             $status = $pesanan['status_pesanan'];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     $badge_class = 'bg-secondary'; // Default
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             // ---- BAGIAN PERUBAHAN UTAMA: Tambahkan kondisi untuk 'pending' ----
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     if ($status == 'menunggu_pembayaran') $badge_class = 'bg-warning text-dark';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             if ($status == 'pending') $badge_class = 'bg-info text-dark'; // Badge baru untuk status pending
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     // ---- AKHIR BAGIAN PERUBAHAN UTAMA ----
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             if ($status == 'diproses') $badge_class = 'bg-primary'; // Mengganti dari bg-info text-dark ke bg-primary agar berbeda dengan pending
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     if ($status == 'dikirim') $badge_class = 'bg-success'; // Mengganti dari bg-primary ke bg-success
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             if ($status == 'selesai') $badge_class = 'bg-success';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     if ($status == 'dibatalkan') $badge_class = 'bg-danger';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             echo '<span class="badge ' . $badge_class . '">' . str_replace('_', ' ', ucfirst($status)) . '</span>';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <td class="d-flex flex-column flex-sm-row gap-2">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <?php if ($pesanan['status_pesanan'] == 'selesai'): ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <a href="detail_pesanan.php?id=<?php echo $pesanan['id']; ?>" class="btn btn-sm btn-warning">Beri Penilaian</a>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <?php else: ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <a href="detail_pesanan.php?id=<?php echo $pesanan['id']; ?>" class="btn btn-sm btn-outline-primary">Lihat Detail</a>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <?php endif; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <?php if ($pesanan['status_pesanan'] == 'menunggu_pembayaran'): ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <form action="batal_pesanan.php" method="POST" onsubmit="return confirm('Apakah Anda yakin ingin membatalkan pesanan ini?');">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <input type="hidden" name="pesanan_id" value="<?php echo $pesanan['id']; ?>">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <button type="submit" class="btn btn-sm btn-outline-danger">Batalkan</button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </form>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <?php endif; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <?php endwhile; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php else: ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <td colspan="5" class="text-center">Anda tidak memiliki pesanan dengan status ini.</td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php endif; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </tbody>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </table>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <?php require_once 'includes/footer.php'; ?>