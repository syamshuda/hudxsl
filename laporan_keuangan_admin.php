<?php
// /admin/laporan_keuangan_admin.php (Versi Final Lengkap & Terperbaiki)
$page_title = "Laporan Keuangan Admin";
require_once '../includes/header_admin.php';

// Pastikan user adalah admin
if (!isset($_SESSION['user_id']) || $_SESSION['role'] !== 'admin') {
    header("Location: /auth/login.php");
        exit();
        }

        // --- Logika Filter ---
        $filter_jenis = $_GET['jenis'] ?? 'semua';
        $filter_admin_id = $_GET['admin_id'] ?? 'semua'; 
        $filter_start_date = $_GET['start_date'] ?? '';
        $filter_end_date = $_GET['end_date'] ?? '';

        // --- Klausa WHERE dinamis untuk filter periode ---
        $where_periode_pesanan = ""; // Untuk query ke tabel 'pesanan'
        $where_periode_transaksi = ""; // Untuk query ke tabel 'riwayat_transaksi_*'
        $bind_periode_params = [];
        $bind_periode_types = "";

        if (!empty($filter_start_date)) {
            // Klausa WHERE untuk tabel pesanan, berdasarkan tanggal pesanan dibuat
                $where_periode_pesanan .= " AND p.tanggal_pesanan >= ?";
                    // Klausa WHERE untuk tabel riwayat, berdasarkan tanggal transaksi terjadi
                        $where_periode_transaksi .= " AND tanggal_transaksi >= ?";
                            $bind_periode_params[] = $filter_start_date . " 00:00:00";
                                $bind_periode_types .= "s";
                                }
                                if (!empty($filter_end_date)) {
                                    $where_periode_pesanan .= " AND p.tanggal_pesanan <= ?";
                                        $where_periode_transaksi .= " AND tanggal_transaksi <= ?";
                                            $bind_periode_params[] = $filter_end_date . " 23:59:59";
                                                $bind_periode_types .= "s";
                                                }

                                                // --- Logika untuk Statistik di Card Atas (Dinamis Sesuai Filter Periode) ---

                                                // 1. Total Uang yang ditransfer pembeli
                                                $transfer_query = "SELECT SUM(p.total_dengan_kode) as total FROM pesanan p WHERE p.status_pesanan NOT IN ('menunggu_pembayaran', 'dibatalkan') $where_periode_pesanan";
                                                $stmt_transfer = $koneksi->prepare($transfer_query);
                                                if (!empty($bind_periode_params)) {
                                                    $stmt_transfer->bind_param($bind_periode_types, ...$bind_periode_params);
                                                    }
                                                    $stmt_transfer->execute();
                                                    $total_transfer_pembeli = (float)$stmt_transfer->get_result()->fetch_assoc()['total'];
                                                    $stmt_transfer->close();

                                                    // 2. Dana untuk Penjual (Total pemasukan di riwayat penjual)
                                                    $dana_penjual_query = "SELECT SUM(jumlah) as total FROM riwayat_transaksi_penjual WHERE jenis_transaksi = 'masuk' $where_periode_transaksi";
                                                    $stmt_dana_penjual = $koneksi->prepare($dana_penjual_query);
                                                    if (!empty($bind_periode_params)) {
                                                        $stmt_dana_penjual->bind_param(str_replace('i', '', $bind_periode_types), ...array_slice($bind_periode_params, 1)); // Menyesuaikan bind jika ada
                                                        }
                                                        $stmt_dana_penjual->execute();
                                                        $total_dana_untuk_penjual = (float)$stmt_dana_penjual->get_result()->fetch_assoc()['total'];
                                                        $stmt_dana_penjual->close();


                                                        // 3. Total Pemasukan Admin (Komisi)
                                                        $pemasukan_query = "SELECT SUM(jumlah) as total FROM riwayat_transaksi_admin rta WHERE rta.jenis_transaksi = 'komisi_masuk' $where_periode_transaksi";
                                                        $stmt_pemasukan = $koneksi->prepare($pemasukan_query);
                                                        if (!empty($bind_periode_params)) {
                                                            $stmt_pemasukan->bind_param($bind_periode_types, ...$bind_periode_params);
                                                            }
                                                            $stmt_pemasukan->execute();
                                                            $total_pemasukan = (float)$stmt_pemasukan->get_result()->fetch_assoc()['total'];
                                                            $stmt_pemasukan->close();

                                                            // 4. Total Pengeluaran Admin (Penarikan dana)
                                                            $pengeluaran_query = "SELECT SUM(jumlah) as total FROM riwayat_transaksi_admin rta WHERE rta.jenis_transaksi = 'penarikan_seller_selesai' $where_periode_transaksi";
                                                            $stmt_pengeluaran = $koneksi->prepare($pengeluaran_query);
                                                            if (!empty($bind_periode_params)) {
                                                                $stmt_pengeluaran->bind_param($bind_periode_types, ...$bind_periode_params);
                                                                }
                                                                $stmt_pengeluaran->execute();
                                                                $total_pengeluaran = (float)$stmt_pengeluaran->get_result()->fetch_assoc()['total'];
                                                                $stmt_pengeluaran->close();

                                                                // 5. Saldo Admin Saat Ini (Nilai ini tidak dipengaruhi oleh filter tanggal)
                                                                $saldo_res = $koneksi->query("SELECT nilai_pengaturan FROM pengaturan WHERE nama_pengaturan = 'saldo_admin'");
                                                                $saldo_admin_aktual = ($saldo_res && $saldo_res->num_rows > 0) ? (float)$saldo_res->fetch_assoc()['nilai_pengaturan'] : 0;


                                                                // --- Logika untuk Tabel Riwayat (Dengan Filter Lengkap) ---
                                                                $where_clauses_table = [];
                                                                $bind_params_table = [];
                                                                $bind_types_table = "";

                                                                if ($filter_jenis !== 'semua') {
                                                                    $where_clauses_table[] = "rta.jenis_transaksi = ?";
                                                                        $bind_params_table[] = $filter_jenis;
                                                                            $bind_types_table .= "s";
                                                                            }
                                                                            if ($filter_admin_id !== 'semua') {
                                                                                $where_clauses_table[] = "rta.admin_user_id = ?";
                                                                                    $bind_params_table[] = (int)$filter_admin_id;
                                                                                        $bind_types_table .= "i";
                                                                                        }
                                                                                        if (!empty($filter_start_date)) {
                                                                                            $where_clauses_table[] = "rta.tanggal_transaksi >= ?";
                                                                                                $bind_params_table[] = $filter_start_date . " 00:00:00";
                                                                                                    $bind_types_table .= "s";
                                                                                                    }
                                                                                                    if (!empty($filter_end_date)) {
                                                                                                        $where_clauses_table[] = "rta.tanggal_transaksi <= ?";
                                                                                                            $bind_params_table[] = $filter_end_date . " 23:59:59";
                                                                                                                $bind_types_table .= "s";
                                                                                                                }

                                                                                                                $where_sql_table = "";
                                                                                                                if (!empty($where_clauses_table)) {
                                                                                                                    $where_sql_table = "WHERE " . implode(" AND ", $where_clauses_table);
                                                                                                                    }
                                                                                                                    $query_riwayat = "
                                                                                                                        SELECT rta.*, u_admin.username AS admin_username
                                                                                                                            FROM riwayat_transaksi_admin rta JOIN users u_admin ON rta.admin_user_id = u_admin.id
                                                                                                                                $where_sql_table
                                                                                                                                    ORDER BY rta.tanggal_transaksi DESC
                                                                                                                                    ";
                                                                                                                                    $stmt_riwayat = $koneksi->prepare($query_riwayat);
                                                                                                                                    if (!empty($bind_params_table)) { 
                                                                                                                                        $stmt_riwayat->bind_param($bind_types_table, ...$bind_params_table);
                                                                                                                                        }
                                                                                                                                        $stmt_riwayat->execute();
                                                                                                                                        $result_riwayat = $stmt_riwayat->get_result();
                                                                                                                                        $result_all_admins = mysqli_query($koneksi, "SELECT id, username FROM users WHERE role = 'admin' ORDER BY username ASC");

                                                                                                                                        $periode_teks = "Keseluruhan";
                                                                                                                                        if (!empty($filter_start_date) || !empty($filter_end_date)) {
                                                                                                                                            $start = !empty($filter_start_date) ? date('d M Y', strtotime($filter_start_date)) : '...';
                                                                                                                                                $end = !empty($filter_end_date) ? date('d M Y', strtotime($filter_end_date)) : '...';
                                                                                                                                                    $periode_teks = "$start - $end";
                                                                                                                                                    }
                                                                                                                                                    ?>

                                                                                                                                                    <div class="no-print">
                                                                                                                                                        <h1>Laporan Keuangan Admin</h1>
                                                                                                                                                            <p>Ringkasan finansial platform berdasarkan periode yang dipilih.</p>
                                                                                                                                                                <hr>
                                                                                                                                                                </div>

                                                                                                                                                                <div class="row">
                                                                                                                                                                    <div class="col-md-6 col-lg-3 mb-4">
                                                                                                                                                                            <div class="card bg-info text-white h-100">
                                                                                                                                                                                        <div class="card-header"><i class="bi bi-box-arrow-in-down"></i> Total Transfer Pembeli</div>
                                                                                                                                                                                                    <div class="card-body">
                                                                                                                                                                                                                    <h4 class="card-title">Rp <?php echo number_format($total_transfer_pembeli, 2, ',', '.'); ?></h4>
                                                                                                                                                                                                                                    <small>Periode: <?php echo $periode_teks; ?></small>
                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                <div class="col-md-6 col-lg-3 mb-4">
                                                                                                                                                                                                                                                                        <div class="card bg-warning text-dark h-100">
                                                                                                                                                                                                                                                                                    <div class="card-header"><i class="bi bi-receipt"></i> Dana untuk Penjual</div>
                                                                                                                                                                                                                                                                                                <div class="card-body">
                                                                                                                                                                                                                                                                                                                <h4 class="card-title">Rp <?php echo number_format($total_dana_untuk_penjual, 2, ',', '.'); ?></h4>
                                                                                                                                                                                                                                                                                                                                <small>Pendapatan bersih penjual pada periode ini.</small>
                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                            <div class="col-md-6 col-lg-3 mb-4">
                                                                                                                                                                                                                                                                                                                                                                    <div class="card bg-success text-white h-100">
                                                                                                                                                                                                                                                                                                                                                                                <div class="card-header"><i class="bi bi-graph-up-arrow"></i> Pemasukan (Komisi)</div>
                                                                                                                                                                                                                                                                                                                                                                                            <div class="card-body">
                                                                                                                                                                                                                                                                                                                                                                                                            <h4 class="card-title">Rp <?php echo number_format($total_pemasukan, 2, ',', '.'); ?></h4>
                                                                                                                                                                                                                                                                                                                                                                                                                             <small>Periode: <?php echo $periode_teks; ?></small>
                                                                                                                                                                                                                                                                                                                                                                                                                                         </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                 </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                     </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                         <div class="col-md-6 col-lg-3 mb-4">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <div class="card bg-primary text-white h-100">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <div class="card-header"><i class="bi bi-safe"></i> Saldo Admin Saat Ini</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <div class="card-body">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <h4 class="card-title">Rp <?php echo number_format($saldo_admin_aktual, 2, ',', '.'); ?></h4>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <small>Total saldo aktual (tidak terpengaruh filter).</small>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <div class="no-print">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <form method="GET" action="" class="mb-4 p-3 border rounded bg-light">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <h5><i class="bi bi-funnel"></i> Filter Laporan</h5>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <div class="row g-3 align-items-end">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <div class="col-md-3">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <label for="start_date_filter" class="form-label">Dari Tanggal</label>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <input type="date" class="form-control" id="start_date_filter" name="start_date" value="<?php echo htmlspecialchars($filter_start_date); ?>">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <div class="col-md-3">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <label for="end_date_filter" class="form-label">Sampai Tanggal</label>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <input type="date" class="form-control" id="end_date_filter" name="end_date" value="<?php echo htmlspecialchars($filter_end_date); ?>">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <div class="col-md-3">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <label for="admin_id_filter" class="form-label">Admin</label>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <select class="form-select" id="admin_id_filter" name="admin_id">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <option value="semua">-- Semua Admin --</option>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php mysqli_data_seek($result_all_admins, 0); while($admin_opt = mysqli_fetch_assoc($result_all_admins)): ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <option value="<?php echo $admin_opt['id']; ?>" <?php if($filter_admin_id == $admin_opt['id']) echo 'selected'; ?>>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <?php echo htmlspecialchars($admin_opt['username']); ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </option>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php endwhile; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </select>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <div class="col-md-auto">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <button type="submit" class="btn btn-primary">Terapkan</button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <a href="laporan_keuangan_admin.php" class="btn btn-secondary">Reset</a>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </form>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <div id="print-area">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <div class="card shadow-sm">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <div class="card-header d-flex justify-content-between align-items-center">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <h5 class="mb-0">Riwayat Transaksi Admin</h5>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <small class="text-muted">Periode: <?php echo $periode_teks; ?></small>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <button class="btn btn-outline-primary no-print" onclick="window.print();"><i class="bi bi-printer"></i> Cetak</button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <div class="card-body">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <div class="table-responsive">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <table class="table table-bordered table-hover">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <thead class="table-light">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <th>Tanggal</th>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <th>Jenis Transaksi</th>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <th>Jumlah</th>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <th>Deskripsi</th>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <th>Admin Proses</th>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <th>Referensi</th>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </thead>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <tbody>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <?php if ($result_riwayat->num_rows > 0): ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php while($riwayat = $result_riwayat->fetch_assoc()): ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <td><?php echo date('d M Y H:i', strtotime($riwayat['tanggal_transaksi'])); ?></td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             $jenis = $riwayat['jenis_transaksi'];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 $badge_class = ($jenis == 'komisi_masuk') ? 'bg-success' : 'bg-danger';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     echo '<span class="badge ' . $badge_class . '">' . ucwords(str_replace('_', ' ', $jenis)) . '</span>';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <td class="<?php echo ($jenis == 'komisi_masuk') ? 'text-success' : 'text-danger'; ?>">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <?php echo ($jenis == 'komisi_masuk') ? '+' : '-'; ?> Rp <?php echo number_format($riwayat['jumlah'], 2, ',', '.'); ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <td><?php echo htmlspecialchars($riwayat['deskripsi']); ?></td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <td><?php echo htmlspecialchars($riwayat['admin_username']); ?></td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <td>#<?php echo $riwayat['referensi_id']; ?></td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <?php endwhile; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <?php else: ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <tr><td colspan="6" class="text-center p-4">Tidak ada data transaksi untuk filter yang dipilih.</td></tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php endif; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </tbody>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <?php if ($result_riwayat->num_rows > 0): ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <tfoot class="table-group-divider fw-bold">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <td colspan="2" class="text-end">Total Pemasukan (Periode ini)</td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <td class="text-success" colspan="4">Rp <?php echo number_format($total_pemasukan, 2, ',', '.'); ?></td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <td colspan="2" class="text-end">Total Pengeluaran (Periode ini)</td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <td class="text-danger" colspan="4">- Rp <?php echo number_format($total_pengeluaran, 2, ',', '.'); ?></td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <tr class="table-light">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <td colspan="2" class="text-end">Laba/Rugi Bersih (Periode ini)</td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <td colspan="4">Rp <?php echo number_format($total_pemasukan - $total_pengeluaran, 2, ',', '.'); ?></td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </tfoot>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <?php endif; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </table>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <style>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              @media print {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  body * { visibility: hidden; }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      .no-print, .no-print * { display: none !important; }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          #print-area, #print-area * { visibility: visible; }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              #print-area { position: absolute; left: 0; top: 0; width: 100%; }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  .card { border: none !important; box-shadow: none !important; }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      .table-responsive { overflow: visible !important; }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          a { text-decoration: none !important; color: #000 !important; }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              .badge { border: 1px solid #dee2e6; color: black !important; background-color: white !important; }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </style>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <?php
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              $stmt_riwayat->close();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              require_once '../includes/footer_admin.php';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ?>