<?php
// /admin/kelola_verifikasi.php
$page_title = "Verifikasi Penjual";
require_once '../includes/header_admin.php';

// Ambil semua toko yang status verifikasinya 'pending'
$query = "
    SELECT 
            t.id as toko_id, 
                    t.nama_toko, 
                            t.foto_ktp, 
                                    t.foto_wajah,
                                            u.nama_lengkap,
                                                    u.email,
                                                            u.created_at as tanggal_daftar
                                                                FROM 
                                                                        toko t
                                                                            JOIN 
                                                                                    users u ON t.user_id = u.id
                                                                                        WHERE 
                                                                                                t.status_verifikasi = 'pending'
                                                                                                    ORDER BY 
                                                                                                            u.created_at ASC
                                                                                                            ";
                                                                                                            $result = $koneksi->query($query);

                                                                                                            if ($result === false) {
                                                                                                                die("Error Query: " . $koneksi->error);
                                                                                                                }
                                                                                                                ?>

                                                                                                                <h1>Verifikasi Penjual</h1>
                                                                                                                <p>Setujui atau tolak permintaan pendaftaran penjual baru berdasarkan data verifikasi yang dikirimkan.</p>

                                                                                                                <?php 
                                                                                                                if (isset($_GET['status'])) {
                                                                                                                    $pesan = isset($_GET['pesan']) ? htmlspecialchars($_GET['pesan']) : '';
                                                                                                                        if ($_GET['status'] == 'sukses') {
                                                                                                                                echo '<div class="alert alert-success">Verifikasi berhasil diproses. ' . $pesan . '</div>';
                                                                                                                                    } elseif ($_GET['status'] == 'gagal') {
                                                                                                                                            echo '<div class="alert alert-danger">Terjadi kesalahan: ' . $pesan . '</div>';
                                                                                                                                                }
                                                                                                                                                }
                                                                                                                                                ?>

                                                                                                                                                <div class="card shadow-sm">
                                                                                                                                                    <div class="card-body">
                                                                                                                                                            <div class="table-responsive">
                                                                                                                                                                        <table class="table table-bordered table-hover align-middle">
                                                                                                                                                                                        <thead class="table-light">
                                                                                                                                                                                                            <tr>
                                                                                                                                                                                                                                    <th>Pemilik</th>
                                                                                                                                                                                                                                                            <th>Email</th>
                                                                                                                                                                                                                                                                                    <th>Tanggal Daftar</th>
                                                                                                                                                                                                                                                                                                            <th class="text-center">Foto KTP</th>
                                                                                                                                                                                                                                                                                                                                    <th class="text-center">Foto Wajah</th>
                                                                                                                                                                                                                                                                                                                                                            <th class="text-center" style="width: 20%;">Aksi</th>
                                                                                                                                                                                                                                                                                                                                                                                </tr>
                                                                                                                                                                                                                                                                                                                                                                                                </thead>
                                                                                                                                                                                                                                                                                                                                                                                                                <tbody>
                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php if ($result && $result->num_rows > 0): ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                            <?php while($toko = $result->fetch_assoc()): ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <td><?php echo htmlspecialchars($toko['nama_lengkap']); ?></td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <td><?php echo htmlspecialchars($toko['email']); ?></td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <td><?php echo date('d M Y, H:i', strtotime($toko['tanggal_daftar'])); ?></td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <td class="text-center">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <a href="/uploads/verifikasi/<?php echo htmlspecialchars($toko['foto_ktp']); ?>" target="_blank">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <img src="/uploads/verifikasi/<?php echo htmlspecialchars($toko['foto_ktp']); ?>" alt="KTP" class="img-thumbnail" width="100">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </a>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <td class="text-center">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <a href="/uploads/verifikasi/<?php echo htmlspecialchars($toko['foto_wajah']); ?>" target="_blank">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <img src="/uploads/verifikasi/<?php echo htmlspecialchars($toko['foto_wajah']); ?>" alt="Wajah" class="img-thumbnail" width="100">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </a>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <td class="text-center">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <form action="proses_verifikasi.php" method="POST" class="d-inline">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <input type="hidden" name="toko_id" value="<?php echo $toko['toko_id']; ?>">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <button type="submit" name="action" value="setujui" class="btn btn-success btn-sm mb-1 w-100">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            Setujui
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </form>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <form action="proses_verifikasi.php" method="POST" class="d-inline">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <input type="hidden" name="toko_id" value="<?php echo $toko['toko_id']; ?>">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <button type="submit" name="action" value="tolak" class="btn btn-danger btn-sm w-100" onclick="return confirm('Apakah Anda yakin ingin menolak verifikasi penjual ini?');">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                Tolak
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </form>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php endwhile; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php else: ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <td colspan="6" class="text-center p-4">Tidak ada permintaan verifikasi baru.</td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php endif; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </tbody>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </table>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <?php 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            $koneksi->close();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            require_once '../includes/footer_admin.php'; 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ?>